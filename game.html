<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Aventura Gráfica</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #2b2b2b;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        canvas {
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/addons/p5.sound.min.js"></script>
</head>

<body>
    <script>
        let escenaActual = 0;
        let fondos = [];
        let dialogos = [];
        let audios = [];

        let musicaFondo;
        let musicaIniciada = false;

        let botonAncho = 300;
        let botonAlto = 40;
        let botonX = 170;
        let boton1Y = 380;
        let boton2Y = 430;

        function preload() {
            soundFormats('mp3', 'ogg');
            musicaFondo = loadSound('data/musicaFondo.mp3');
            audios[0] = musicaFondo;

            dialogos = loadStrings("data/historia.txt");

            for (let i = 0; i <= 18; i = i + 1) {
                fondos[i] = loadImage('data/imagen_' + i + '.png');
            }
        }

        function setup() {
            createCanvas(640, 480);
            textSize(20);
            textAlign(LEFT, TOP);
        }

        function draw() {
            dibujarEscena(escenaActual);
        }

        function dibujarEscena(n) {
            pintarFondo(n);

            if (n >= 0 && n <= 18) {
                mostrarDialogo(dialogos[n]);
            }

            if (esMomentoDecision(n)) {
                pintarDosBotones(n);
            } else if (esEscenaFinal(n) || n === 18) {
                pintarBotonesFin(n);
            } else {
                pintarBotonContinuar();
            }
        }

        function esMomentoDecision(n) {
            return n === 4 || n === 7 || n === 15;
        }

        function esEscenaFinal(n) {
            return n === 9 || n === 10 || n === 14 || n === 17;
        }

        function mousePressed() {
            if (musicaIniciada === false) {
                if (musicaFondo.isLoaded()) {
                    musicaFondo.loop();
                    musicaIniciada = true;
                }
                return;
            }

            // Pantalla de DECISIÓN (4, 7 o 15)
            if (esMomentoDecision(escenaActual)) {
                manejarClickDecision(escenaActual);
            }
            // Pantalla de FINAL (9, 10, 14, 17)
            else if (esEscenaFinal(escenaActual)) {
                manejarClickFinal();
            }
            // Pantalla de CRÉDITOS
            else if (escenaActual === 18) {
                manejarClickCreditos();
            }
            // CUALQUIER OTRA PANTALLA
            else {
                manejarAvanceSimple();
            }
        }

        function manejarAvanceSimple() {
            if (mouseSobre(botonX, boton1Y, botonAncho, botonAlto)) {
                if (escenaActual === 12) {
                    escenaActual = 15;
                    return;
                }
                escenaActual++;
            }
        }

        function manejarClickDecision(n) {
            // Botón superior
            if (mouseSobre(botonX, boton1Y, botonAncho, botonAlto)) {
                escenaActual = obtenerOpcionA(n);
            }
            // Botón inferior
            else if (mouseSobre(botonX, boton2Y, botonAncho, botonAlto)) {
                escenaActual = obtenerOpcionB(n);
            }
        }

        function obtenerOpcionA(n) {
            if (n === 4) return 5;
            if (n === 7) return 11;
            if (n === 15) return 16;
            return n + 1;
        }

        function obtenerOpcionB(n) {
            if (n === 4) return 8;
            if (n === 7) return 13;
            if (n === 15) return 10;
            return n + 1;
        }

        function manejarClickFinal() {
            if (mouseSobre(botonX, boton1Y, botonAncho, botonAlto)) {
                escenaActual = 1;
            }
            else if (mouseSobre(botonX, boton2Y, botonAncho, botonAlto)) {
                escenaActual = 18;
            }
        }

        function manejarClickCreditos() {
            if (mouseSobre(botonX, boton1Y, botonAncho, botonAlto)) {
                escenaActual = 1;
            }
        }

        function pintarFondo(n) {
            if (fondos[n]) {
                image(fondos[n], 0, 0, width, height);
            } else {
                background(20, 0, 20);
                fill(255);
                textAlign(CENTER, CENTER);
                text("Error: Falta la imagen " + n, width / 2, height / 2);
                textAlign(LEFT, TOP);
            }
        }

        function pintarDosBotones(n) {
            let textoA, textoB;
            if (n === 4) {
                textoA = dialogos[20];
                textoB = dialogos[21];
            } else if (n === 7) {
                textoA = dialogos[22];
                textoB = dialogos[23];
            } else if (n === 15) {
                textoA = dialogos[24];
                textoB = dialogos[25];
            }

            crearBoton(textoA, botonX, boton1Y);
            crearBoton(textoB, botonX, boton2Y);
        }

        function pintarBotonContinuar() {
            crearBoton(dialogos[19], botonX, boton1Y);
        }

        function pintarBotonesFin(n) {
            if (n === 18) {
                crearBoton(dialogos[28] || dialogos[26], botonX, boton1Y);
            } else {
                crearBoton(dialogos[26], botonX, boton1Y);
                crearBoton(dialogos[27], botonX, boton2Y);
            }
        }

        function mostrarDialogo(texto) {
            fill(0, 0, 0, 150);
            noStroke();
            rect(30, height - 220, width - 60, 130, 20);
            fill(255);
            textSize(20);
            textAlign(LEFT, TOP);
            let textoMostrar = texto === undefined ? "Error: Texto no encontrado en historia.txt" : texto;
            text(textoMostrar, 50, height - 210, width - 100, 120);
            textAlign(LEFT, TOP);
        }

        function crearBoton(texto, x, y) {
            fill(0, 0, 0, 100);
            noStroke();
            rect(x + 3, y + 3, botonAncho, botonAlto, 10);
            if (mouseSobre(x, y, botonAncho, botonAlto)) {
                fill(150, 120, 80);
            } else {
                fill(100, 80, 50);
            }
            stroke(200, 160, 100);
            strokeWeight(1);
            rect(x, y, botonAncho, botonAlto, 10);

            // Texto del botón
            noStroke();
            fill(255);
            textSize(16);
            textAlign(CENTER, CENTER);
            let textoMostrar = texto === undefined ? "Error: Botón sin texto" : texto;
            text(textoMostrar, x + botonAncho / 2, y + botonAlto / 2);
            textAlign(LEFT, TOP);
        }
        function mouseSobre(x, y, w, h) {
            return mouseX > x && mouseX < x + w && mouseY > y && mouseY < y + h;
        }
    </script>
</body>

</html>